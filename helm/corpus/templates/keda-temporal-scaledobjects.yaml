{{/*
KEDA ScaledObjects for Temporal workers
*/}}
{{- if .Values.keda.enabled }}
{{- $fullname := include "corpus.fullname" . -}}
{{- $labels := include "corpus.labels" . -}}

{{/* TriggerAuthentication for Temporal Cloud API key auth */}}
{{- if .Values.keda.temporal.apiKeySecretRef }}
---
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: {{ $fullname }}-temporal-auth
  labels:
    {{- $labels | nindent 4 }}
spec:
  secretTargetRef:
    - parameter: apiKey
      name: {{ .Values.keda.temporal.apiKeySecretRef.name }}
      key: {{ .Values.keda.temporal.apiKeySecretRef.key }}
{{- end }}

{{- if .Values.temporalWorkers.routing.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-routing-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-routing-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-routing-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.routing.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.routing.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.routing.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.routing.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- if .Values.temporalWorkers.pdf.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-pdf-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-pdf-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-pdf-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.pdf.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.pdf.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.pdf.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.pdf.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- if .Values.temporalWorkers.page.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-page-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-page-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-page-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.page.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.page.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.page.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.page.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- if .Values.temporalWorkers.generic.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-generic-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-generic-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-generic-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.generic.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.generic.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.generic.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.generic.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- if .Values.temporalWorkers.chunking.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-chunking-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-chunking-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-chunking-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.chunking.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.chunking.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.chunking.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.chunking.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- if .Values.temporalWorkers.workflow.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-workflow-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-workflow-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-workflow-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.workflow.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.workflow.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.workflow.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.workflow.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- if .Values.temporalWorkers.qa.enabled }}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: {{ $fullname }}-temporal-qa-worker-scaler
  labels:
    {{- $labels | nindent 4 }}
    app.kubernetes.io/component: temporal-qa-worker
spec:
  scaleTargetRef:
    name: {{ $fullname }}-temporal-qa-worker
  minReplicaCount: {{ .Values.keda.temporalWorkers.qa.minReplicas | default 1 }}
  maxReplicaCount: {{ .Values.keda.temporalWorkers.qa.maxReplicas }}
  pollingInterval: {{ .Values.keda.pollingInterval }}
  cooldownPeriod: {{ .Values.keda.cooldownPeriod }}
  triggers:
    - type: temporal
      {{- if .Values.keda.temporal.apiKeySecretRef }}
      authenticationRef:
        name: {{ $fullname }}-temporal-auth
      {{- end }}
      metadata:
        namespace: {{ .Values.keda.temporal.namespace | default "default" }}
        taskQueue: {{ .Values.keda.temporalWorkers.qa.queueName }}
        targetQueueSize: {{ .Values.keda.temporalWorkers.qa.queueLength | quote }}
        activationTargetQueueSize: "1"
        endpoint: {{ .Values.keda.temporal.endpoint | default "temporal-frontend.temporal.svc.cluster.local:7233" }}
        queueTypes: workflow,activity
        selectAllActive: "false"
        selectUnversioned: "true"
        unsafeSsl: {{ .Values.keda.temporal.unsafeSsl | default "false" | quote }}
{{- end }}

{{- end }}
